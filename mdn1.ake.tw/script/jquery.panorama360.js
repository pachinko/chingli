/*
 * panorama360 - jQuery plugin made by Liviu Holhos
 * Copyright (c) 2012 Liviu Holhos (http://liviuholhos.com/)
 */
 (function(a){a.fn.panorama360=function(b){function c(a){a.preventDefault();return false}function d(a,b,c,d){var e=parseInt(a.css("marginLeft"))+c;if(d.is360){if(e>0)e=-b;if(e<-b)e=0}else{var f=-(b-a.parent().width());if(e>0){e=0;if(d.sliding_direction)d.sliding_direction*=-1}if(e<f){e=f;if(d.sliding_direction)d.sliding_direction*=-1}}a.css("marginLeft",e+"px")}function e(b,c,d,e){var f=d/c;b.each(function(){area_coord=a(this).data("coords");stitch=a(this).data("stitch");switch(stitch){case 1:a(this).css({left:area_coord[0]*f+"px",top:area_coord[1]*f+"px",width:(area_coord[2]-area_coord[0])*f+"px",height:(area_coord[3]-area_coord[1])*f+"px"});break;case 2:a(this).css({left:e+parseInt(area_coord[0])*f+"px",top:area_coord[1]*f+"px",width:(area_coord[2]-area_coord[0])*f+"px",height:(area_coord[3]-area_coord[1])*f+"px"});break}})}return this.each(function(){var f={start_position:0,image_width:0,image_height:0,mouse_wheel_multiplier:10,bind_resize:true,is360:true,sliding_controls:false,sliding_direction:0,sliding_interval:8,use_preloader:true};if(b)a.extend(f,b);var g=a(this);var h=g.children(".panorama-container");var i=h.children("img:first-child");if(f.use_preloader){g.css("display","none");var j=g.parent().find(".preloader");if(j.length==0){j=a('<div class="preloader"></div>').insertAfter(g)}a("img").one("load",function(){g.fadeIn(200);j.hide()}).each(function(){if(this.complete||this.readyState===4)a(this).load()})}if(f.image_width<=0&&f.image_height<=0){f.image_width=parseInt(i.data("width"));f.image_height=parseInt(i.data("height"));if(!f.image_width||!f.image_height)return}var k=f.image_height/f.image_width;var l=parseInt(g.height());var m=parseInt(l/k);var n=i.attr("usemap");var o;var p=false;var q=0;var r=0;var s=false;if(f.is360)i.removeAttr("usemap").css("left",0).clone().css("left",m+"px").insertAfter(i);h.css({"margin-left":"-"+f.start_position+"px",width:m*2+"px",height:l+"px"});setInterval(function(){if(p)return false;if(r<-2||2<r)r*=.98;else if(f.sliding_direction)r=-f.sliding_direction*2;else r=0;if(r)d(h,m,r,f)},f.sliding_interval);g.unbind("mousedown mouseup mousemove mouseout mousewheel contextmenu touchmove touchend");g.mousedown(function(b){if(p)return false;a(this).addClass("grab");p=true;q=b.clientX;scrollOffset=0;return false}).mouseup(function(){a(this).removeClass("grab");p=false;if(f.sliding_direction)f.sliding_direction=r>0?-1:1;r=r*.45;return false}).mousemove(function(a){if(!p)return false;r=parseInt(a.clientX-q);q=a.clientX;d(h,m,r,f);return false}).mouseout(function(a){p=false}).bind("mousewheel",function(a,b){var c=Math.ceil(Math.sqrt(Math.abs(b)));if(f.sliding_direction!=0){f.sliding_direction=b<0?1:-1}c=b<0?-c:c;r=r+c*5;d(h,m,c*f.mouse_wheel_multiplier,f);return false}).bind("contextmenu",c).bind("touchstart",function(a){if(p)return false;p=true;q=a.originalEvent.touches[0].pageX;scrollOffset=0}).bind("touchmove",function(a){a.preventDefault();if(!p)return false;var b=a.originalEvent.touches[0].pageX;r=parseInt(b-q);q=b;d(h,m,r,f)}).bind("touchend",function(a){p=false;if(f.sliding_direction)f.sliding_direction=r>0?-1:1;r=r*.45});if(n){new_area=a("a").addClass("area");a("map[name="+n+"]",h).children("area").each(function(){switch(a(this).attr("shape").toLowerCase()){case"rect":var b=a(this).attr("coords").split(",");var c=a(document.createElement("a")).addClass("area").attr("href",a(this).attr("href")).attr("title",a(this).attr("alt"));c.addClass(a(this).attr("class"));h.append(c.data("stitch",1).data("coords",b));h.append(c.clone().data("stitch",2).data("coords",b));break}});a("map[name="+n+"]",h).remove();o=h.children(".area");o.mouseup(c).mousemove(c).mousedown(c);e(o,f.image_height,l,m)}if(f.sliding_controls){var t=g.parent().find(".controls");if(t.length==0){var t=a('<div class="controls"></div>').insertAfter(g);a('<a class="prev"><span>&#9664;</span></a>').click(function(a){f.sliding_direction=-1;a.preventDefault()}).appendTo(t);a('<a class="stop"><span>&#8718</span></a>').click(function(a){f.sliding_direction=0;a.preventDefault()}).appendTo(t);a('<a class="next"><span>&#9654;</span></a>').click(function(a){f.sliding_direction=1;a.preventDefault()}).appendTo(t)}}if(f.bind_resize&&!s){s=true;a(window).resize(function(){$parent=g.parent();l=parseInt($parent.height());m=parseInt(l/k);h.css({width:m*2+"px",height:l+"px"});i.css("left",0).next().css("left",m+"px");if(n)e(o,f.image_height,l,m)})}if(f.loaded&&a.isFunction(loaded)){f.loaded()}if(f.callback&&a.isFunction(f.callback)){var u=0;a(".panorama-container img").load(function(a){u+=1;if(u==2)f.callback()})}})}})(jQuery)